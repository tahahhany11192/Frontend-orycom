<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Orycom Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    :root {
      --primary-color: #7b2cbf;
      --secondary-color: #9d4edd;
      --accent-color: #ff9e00;
      --success-color: #25D366;
      --warning-color: #ffaa00;
      --danger-color: #ff0054;
      --text-color: #333;
      --light-text: #667781;
      --chat-bg: #e6e6e6;
      --sidebar-bg: #ffffff;
      --border-color: #e0e0e0;
      --my-message-bg: #DCF8C6;
      --other-message-bg: #ffffff;
      --active-chat: #ebebeb;
      --input-bg: #f0f0f0;
      --dark-bg: #10002b;
      --card-bg: rgba(29, 17, 53, 0.8);
      --sidebar-bg-dark: rgba(41, 21, 81, 0.6);
      --header-gradient: linear-gradient(to right, #9d4edd, #ff9e00);
      --message-bg: rgba(157, 78, 221, 0.1);
      --my-message-bg-dark: rgba(123, 44, 191, 0.3);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #10002b, #240046);
      color: #f8f9fa;
      height: 100vh;
      overflow: hidden;
      display: flex;
    }

    .app-container {
      display: flex;
      width: 100%;
      height: 100%;
      max-width: 1600px;
      margin: 0 auto;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }

    /* Chat list sidebar */
    .chat-list-sidebar {
      width: 30%;
      min-width: 300px;
      background: var(--sidebar-bg-dark);
      backdrop-filter: blur(10px);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    .chat-header {
      padding: 15px;
      background: rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--secondary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }

    .header-actions {
      display: flex;
      gap: 15px;
    }

    .header-actions i {
      color: rgba(255, 255, 255, 0.7);
      cursor: pointer;
      font-size: 18px;
    }

    .search-container {
      padding: 10px 15px;
      background: rgba(0, 0, 0, 0.1);
    }

    .search-wrapper {
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 10px 15px 10px 40px;
      border-radius: 20px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-family: inherit;
      font-size: 14px;
    }

    .search-input:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.15);
    }

    .search-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .search-wrapper i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(255, 255, 255, 0.7);
    }

    .chat-list {
      flex: 1;
      overflow-y: auto;
    }

    .chat-item {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      gap: 15px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chat-item:hover {
      background: rgba(157, 78, 221, 0.1);
    }

    .chat-item.active {
      background: rgba(157, 78, 221, 0.2);
    }

    .chat-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--secondary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 18px;
    }

    .chat-info {
      flex: 1;
    }

    .chat-name {
      font-weight: 600;
      margin-bottom: 5px;
    }

    .chat-preview {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .chat-time {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 5px;
    }

    .chat-badge {
      background: var(--success-color);
      color: white;
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 50%;
    }

    /* Main chat area */
    .main-chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: rgba(16, 0, 43, 0.7);
      position: relative;
    }

    .current-chat-header {
      padding: 15px;
      background: var(--sidebar-bg-dark);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      gap: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .current-chat-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: var(--secondary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 16px;
    }

    .current-chat-info {
      flex: 1;
    }

    .current-chat-name {
      font-weight: 600;
    }

    .current-chat-status {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.7);
    }

    .chat-header-actions {
      display: flex;
      gap: 15px;
    }

    .chat-header-actions i {
      color: rgba(255, 255, 255, 0.7);
      cursor: pointer;
      font-size: 18px;
    }

    .messages-container {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%239C92AC' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
    }

    .message {
      max-width: 65%;
      padding: 10px 15px;
      border-radius: 8px;
      position: relative;
      line-height: 1.5;
    }

    .message-time {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.6);
      text-align: right;
      margin-top: 5px;
    }

    .my-message {
      align-self: flex-end;
      background: var(--my-message-bg-dark);
      border: 1px solid rgba(123, 44, 191, 0.5);
      border-top-right-radius: 2px;
    }

    .other-message {
      align-self: flex-start;
      background: var(--message-bg);
      border: 1px solid rgba(157, 78, 221, 0.3);
      border-top-left-radius: 2px;
    }

    .message-composer {
      padding: 15px;
      background: var(--sidebar-bg-dark);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .message-input {
      flex: 1;
      padding: 12px 15px;
      border-radius: 20px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-family: inherit;
      font-size: 15px;
    }

    .message-input:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.15);
    }

    .message-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .send-button {
      background: var(--secondary-color);
      color: white;
      border: none;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .action-button {
      color: rgba(255, 255, 255, 0.7);
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
    }

    /* Empty state */
    .empty-chat {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: rgba(255, 255, 255, 0.5);
      text-align: center;
      padding: 20px;
    }

    .empty-chat i {
      font-size: 80px;
      margin-bottom: 20px;
      color: rgba(255, 255, 255, 0.2);
    }

    .empty-chat h2 {
      font-weight: 300;
      margin-bottom: 10px;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .chat-list-sidebar {
        width: 100%;
        min-width: auto;
      }
      
      .main-chat {
        display: none;
        width: 100%;
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
      }
      
      .main-chat.active {
        display: flex;
      }
      
      .back-button {
        display: block !important;
      }
    }

    @media (min-width: 769px) {
      .back-button {
        display: none !important;
      }
    }

    .back-button {
      background: none;
      border: none;
      font-size: 20px;
      color: rgba(255, 255, 255, 0.7);
      cursor: pointer;
      display: none;
      margin-right: 10px;
    }

    /* Animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message {
      animation: fadeIn 0.3s ease;
    }
    .logo {
  display: flex;
  align-items: center;
  animation: logoFloat 4s ease-in-out infinite;
}

.logo img {
  height: 68px; /* Adjust as needed */
  width: auto;
  margin-right: 10px; /* Space between logo and text */
}

    .back-button {
  display: inline-flex;
  align-items: center;
  padding: 10px 16px;
  background-color: #4a6cf7;
  color: white;
  text-decoration: none;
  border-radius: 6px;
  font-family: 'Segoe UI', sans-serif;
  font-weight: 500;
  transition: all 0.3s ease;
  margin: 15px;
}

.back-button:hover {
  background-color: #3a5cd8;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.back-button i {
  margin-right: 8px;
}
  </style>
</head>
<body>
  <!-- Header with Navigation -->
  

  <div class="app-container">
<a href="javascript:history.back()" class="back-button">
  <i class="fas fa-arrow-left"></i>
  Back
</a>
    <!-- Chat list sidebar -->
    <div class="chat-list-sidebar" id="chat-list-sidebar">
      <div class="chat-header">
        <div class="user-profile">
          <div class="user-avatar">
            <i class="fas fa-user"></i>
          </div>
          <div class="user-name">You</div>
        </div>
        <div class="header-actions">
          <i class="fas fa-status"></i>
          <i class="fas fa-comment-alt"></i>
          <i class="fas fa-ellipsis-v"></i>
        </div>
      </div>
      
      <div class="search-container">
        <div class="search-wrapper">
          <i class="fas fa-search"></i>
          <input type="text" class="search-input" placeholder="Search or start new chat" id="searchInput">
        </div>
        <ul id="searchResults"></ul>
      </div>
      
      <div class="chat-list" id="chat-list">
        <!-- Chat items will be populated here -->
      </div>
    </div>
    
    <!-- Main chat area -->
    <div class="main-chat" id="main-chat">
      <div class="current-chat-header">
        <button class="back-button" id="back-button">
          <i class="fas fa-arrow-left"></i>
        </button>
        <div class="current-chat-avatar" id="current-chat-avatar">G</div>
        <div class="current-chat-info">
          <div class="current-chat-name" id="current-chat-name">Select a chat</div>
          <div class="current-chat-status" id="current-chat-status">Online</div>
        </div>
        <div class="chat-header-actions">
          <i class="fas fa-video"></i>
          <i class="fas fa-phone"></i>
          <i class="fas fa-ellipsis-v"></i>
        </div>
      </div>
      
      <div class="messages-container" id="messages-container">
        <div class="empty-chat" id="empty-chat">
          <i class="fas fa-comments"></i>
          <h2>Orycom Chat</h2>
          <p>Select a chat from the list to start messaging</p>
        </div>
      </div>
      
      <div class="message-composer" id="message-composer" style="display: none;">
        <button class="action-button">
          <i class="fas fa-paperclip"></i>
        </button>
        <input type="text" class="message-input" placeholder="Type a message" id="message-input">
        <button class="action-button">
          <i class="fas fa-smile"></i>
        </button>
        <button class="send-button" id="send-button">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const API_BASE = "https://orycom-backend.fly.dev/api/chat";
    const SOCKET_URL = "https://orycom-backend.fly.dev";
    const TOKEN = localStorage.getItem("userToken");
    const USER_ID = localStorage.getItem("userId");
    const USER_NAME = localStorage.getItem("userName") || "You";
    const USER_ROLE = localStorage.getItem("userRole") || "user";

    if (!TOKEN) {
      alert("You must be logged in. Missing userToken in localStorage.");
    }

    // ====== STATE ======
    let socket = null;
    let currentRoomId = null;
    let messages = [];
    let rooms = [];
    let pendingMessages = new Set();

    // ====== DOM refs ======
    const chatList = document.getElementById("chat-list");
    const messagesContainer = document.getElementById("messages-container");
    const messageComposer = document.getElementById("message-composer");
    const messageInput = document.getElementById("message-input");
    const sendButton = document.getElementById("send-button");
    const currentChatName = document.getElementById("current-chat-name");
    const currentChatAvatar = document.getElementById("current-chat-avatar");
    const currentChatStatus = document.getElementById("current-chat-status");
    const emptyChat = document.getElementById("empty-chat");
    const searchInput = document.getElementById("searchInput");
    const searchResults = document.getElementById("searchResults");
    const backButton = document.getElementById("back-button");
    const mainChat = document.getElementById("main-chat");
    const chatListSidebar = document.getElementById("chat-list-sidebar");

    // ====== Initialize the app ======
    document.addEventListener('DOMContentLoaded', function() {
      init();
      setupEventListeners();
    });

    function setupEventListeners() {
      // Back button for mobile
      backButton.addEventListener('click', function() {
        if (window.innerWidth <= 768) {
          mainChat.classList.remove('active');
          chatListSidebar.style.display = 'flex';
        }
      });

      // Send message on button click
      sendButton.addEventListener('click', sendMessage);

      // Send message on Enter key
      messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });

      // Search functionality
      searchInput.addEventListener("input", debounce(handleSearch, 300));
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // ====== Search functionality ======
    async function handleSearch() {
      const query = searchInput.value.trim();
      if (!query) {
        searchResults.innerHTML = "";
        return;
      }

      try {
        const res = await fetch(`https://orycom-backend.fly.dev/api/search?q=${encodeURIComponent(query)}`, {
          headers: {
            "Authorization": `Bearer ${TOKEN}`
          }
        });
        
        if (!res.ok) {
          throw new Error('Search failed');
        }

        const data = await res.json();
        
        if (!Array.isArray(data)) {
          console.error("Unexpected search result format:", data);
          searchResults.innerHTML = "<li>No results found</li>";
          return;
        }

        if (data.length === 0) {
          searchResults.innerHTML = "<li>No users found</li>";
          return;
        }

        searchResults.innerHTML = "";

        data.forEach(item => {
          const userId = item.id;
          const userName = item.label || 'Unknown';
          const userType = item.type || 'user';
          
          if (userId) {
            const li = document.createElement("li");
            li.className = "chat-item";
            li.innerHTML = `
              <div class="chat-avatar">${userName.charAt(0)}</div>
              <div class="chat-info">
                <div class="chat-name">${userName}</div>
                <div class="chat-preview">${userType}</div>
              </div>
            `;
            li.addEventListener("click", () => {
              selectUser(userId, userName, userType);
            });
            searchResults.appendChild(li);
          }
        });

      } catch (error) {
        console.error("Search error:", error);
        searchResults.innerHTML = "<li>Error searching</li>";
      }
    }

    function selectUser(userId, userName, userType) {
      if (!userId) {
        console.error("Invalid user selection - missing ID");
        return;
      }
      
      ensureDmWithTarget(userType, userId, userName);
      
      searchResults.innerHTML = "";
      searchInput.value = "";
    }

    // ====== API Helpers ======
    const api = (path, opts={}) => fetch(`${API_BASE}${path}`, {
      ...opts,
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${TOKEN}`,
        ...(opts.headers || {})
      }
    });

    function formatTimestamp(ts){
      try { 
        const date = new Date(ts);
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      } catch { 
        return ts; 
      }
    }

    function scrollToBottom(){
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function escapeHtml(str){
      return (str || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    }

    // ====== App flow ======
    async function init(){
      // Initialize socket connection
      socket = io(SOCKET_URL, { 
        auth: { 
          token: TOKEN,
          userId: USER_ID 
        } 
      });

      socket.on('connect', () => console.log('Socket connected', socket.id));
      socket.on('disconnect', () => console.log('Socket disconnected'));
      socket.on('chat:joined', (rid)=> console.log('Joined room via socket', rid));

      socket.on('chat:message', (payload) => {
        if (!currentRoomId || payload.roomId !== currentRoomId) return;
        
        const m = payload.message;
        
        // Skip if this is our own message that we already optimistically added
        if (m.senderId === USER_ID && pendingMessages.has(m._id)) {
          pendingMessages.delete(m._id);
          return;
        }
        
        messages.push(mapMessage(m));
        renderMessages();
      });

      // Load initial rooms
      await refreshRooms();
    }

    function mapMessage(m){
      return {
        _id: m._id,
        text: m.text,
        senderName: m.senderName || m.senderRole,
        senderRole: m.senderRole,
        senderId: m.senderId,
        createdAt: m.createdAt || new Date().toISOString(),
        isMe: m.senderId === USER_ID
      };
    }

    async function refreshRooms(){
      try {
        const res = await api('/rooms');
        const data = await res.json();
        if (!res.ok) { 
          console.error(data); 
          return; 
        }
        
        rooms = data.rooms || [];
        renderChatList(rooms);
      } catch (error) {
        console.error("Error fetching rooms:", error);
      }
    }

    function renderChatList(roomsList) {
      chatList.innerHTML = "";
      
      if (roomsList.length === 0) {
        chatList.innerHTML = `<div class="empty-chat"><p>No chats yet</p></div>`;
        return;
      }
      
      roomsList.forEach(room => {
        const chatItem = document.createElement('div');
        chatItem.className = "chat-item" + (room._id === currentRoomId ? " active" : "");
        
        const title = room.title || 
          (room.type === 'dm' ? 
            (room.participants || [])
              .filter(p => p._id !== USER_ID)
              .map(p => p.displayName)
              .join(', ') : 
            room.type.charAt(0).toUpperCase() + room.type.slice(1));
        
        const lastMessage = room.lastMessage || "No messages yet";
        const lastMessageTime = room.lastMessageTime ? formatTimestamp(room.lastMessageTime) : "";
        
        chatItem.innerHTML = `
          <div class="chat-avatar">${title.charAt(0)}</div>
          <div class="chat-info">
            <div class="chat-name">${title}</div>
            <div class="chat-preview">${lastMessage}</div>
          </div>
          <div class="chat-meta">
            <div class="chat-time">${lastMessageTime}</div>
            ${room.unreadCount > 0 ? `<div class="chat-badge">${room.unreadCount}</div>` : ''}
          </div>
        `;
        
        chatItem.onclick = () => openRoom(room);
        chatList.appendChild(chatItem);
      });
    }

    function renderMessages(){
      messagesContainer.innerHTML = "";
      
      if (!messages.length){
        emptyChat.style.display = 'flex';
        messagesContainer.appendChild(emptyChat);
      } else {
        emptyChat.style.display = 'none';
        
        messages.forEach(m => {
          const messageElement = document.createElement('div');
          messageElement.className = `message ${m.isMe ? 'my-message' : 'other-message'}`;
          
          messageElement.innerHTML = `
            <div>${escapeHtml(m.text || '')}</div>
            <div class="message-time">${formatTimestamp(m.createdAt)}</div>
          `;
          
          messagesContainer.appendChild(messageElement);
        });
        
        scrollToBottom();
      }
    }

    async function openRoom(room){
      if (currentRoomId) {
        socket.emit('chat:leave', currentRoomId);
      }

      currentRoomId = room._id;
      messages = [];
      pendingMessages.clear();

      // Update UI
      const title = room.title || 
        (room.participants || [])
          .filter(p => p._id !== USER_ID)
          .map(p => p.displayName)
          .join(', ');
      
      currentChatName.textContent = title;
      currentChatAvatar.textContent = title.charAt(0);
      currentChatStatus.textContent = room.type === 'dm' ? 'Online' : `${room.participants?.length || 1} participants`;
      
      messageComposer.style.display = 'flex';
      messageInput.value = '';
      messageInput.focus();

      // Show chat area on mobile
      if (window.innerWidth <= 768) {
        chatListSidebar.style.display = 'none';
        mainChat.classList.add('active');
      }

      // Join room and load messages
      socket.emit('chat:join', currentRoomId);
      await fetchMessages();

      // Update active chat in list
      renderChatList(rooms);
    }

    async function fetchMessages(before=null){
      try {
        let url = `/rooms/${currentRoomId}/messages?limit=30`;
        if (before) url += `&before=${encodeURIComponent(before)}`;
        
        const res = await api(url);
        const data = await res.json();
        
        if (!res.ok){ 
          console.error(data); 
          return; 
        }

        messages = (data.messages || []).map(mapMessage);
        renderMessages();
      } catch (error) {
        console.error("Error fetching messages:", error);
      }
    }

    async function ensureDmWithTarget(targetRole, targetId, targetName) {
      if (!targetRole || !['user','instructor','admin'].includes(targetRole)) {
        console.error("Invalid target role:", targetRole);
        return;
      }
      if (!targetId) {
        console.error("Missing target ID");
        return;
      }

      try {
        const res = await api('/rooms/dm', {
          method: 'POST',
          body: JSON.stringify({ targetRole, targetId })
        });
        
        const data = await res.json();
        
        if (!res.ok) {
          console.error("Failed to create DM:", data);
          alert(data.error || 'Failed to create DM');
          return;
        }

        await refreshRooms();
        
        const roomsRes = await api('/rooms');
        const roomsData = await roomsRes.json();
        const room = (roomsData.rooms || []).find(r => r._id === data.roomId) || { 
          _id: data.roomId, 
          type: 'dm',
          participants: [{ displayName: targetName }] 
        };
        
        openRoom(room);
        
      } catch (error) {
        console.error("Error creating DM:", error);
        alert("Error creating DM");
      }
    }

    async function sendMessage(){
      const text = messageInput.value.trim();
      if (!text || !currentRoomId) return;

      // Create temporary ID for optimistic update
      const tempId = 'temp-' + Date.now();
      pendingMessages.add(tempId);

      // Optimistic update
      const optimisticMessage = {
        _id: tempId,
        text: text,
        senderName: USER_NAME,
        senderRole: USER_ROLE,
        senderId: USER_ID,
        createdAt: new Date().toISOString(),
        isMe: true
      };
      messages.push(optimisticMessage);
      renderMessages();
      messageInput.value = '';
      scrollToBottom();

      try {
        const res = await api(`/rooms/${currentRoomId}/messages`, {
          method: 'POST',
          body: JSON.stringify({ text })
        });
        
        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.error || 'Failed to send message');
        }

        // Replace temporary message when real one arrives via socket
        pendingMessages.add(data.message._id);
        
      } catch (error) {
        console.error("Message send error:", error);
        // Remove optimistic message if failed
        messages = messages.filter(m => m._id !== tempId);
        renderMessages();
        pendingMessages.delete(tempId);
        alert("Failed to send message");
      }
    }
  </script>
</body>
</html>
